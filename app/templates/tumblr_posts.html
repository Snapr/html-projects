<div id="tumblr-posts" data-tab-bar="true" data-title="Tumblr <%= T('blog') %>" data-add-back-btn="true" data-role="page" data-theme="d">
    <div data-role="header" data-theme="b">
        <h1><%= T('News') %></h1>
        <div class="ui-btn-right" data-ajax="false">
            <a href="#/search/" data-snapr-dialog="true" data-role="button" data-icon="search" data-iconpos="notext"></a>
            <a href="#/home/" data-role="button" data-icon="home" data-iconpos="notext"></a>
        </div>
    </div>
    <div data-role="content" data-theme="d" data-ajax="false">
        <div class="s-tumblr-body">
            <a class="ui-bar s-ui-bar-dropdown s-arrow-d-left x-details <% if(config.get('dropdown_menu_options')){ %>x-has-dropdown<% } %>" data-role="button" data-iconpos="left" data-icon="blog" data-theme="e">
                    <strong class="x-blog-title"><span><%= obj.title  %></span></strong>
                    <span class="ui-icon ui-icon-arrow-d"></span>
                    
            </a>

            <% if(config.get('dropdown_menu_options')){ %>
            <ul class="x-dropdown s-dropdown">
                <% _.each(config.get('dropdown_menu_options'), function(item){ %>
                    <% if(item.url.split('?')[0] != window.location.hash.split('?')[0]){ %>
                        <% if(
                            (item.show_for == "logged_in_only" && !auth.has('access_token')) ||
                            (item.show_for == "logged_out_only" && auth.has('access_token'))
                        ){ return } %>
                        <li>
                            <a href="<%= item.url %>" class="ui-bar" data-role="button" data-theme="b" data-icon="<%= item.icon %>" data-icon-pos="left"><%= T(item.label) %></a>
                        </li>
                    <% } %>
                <% }) %>
            </ul>
            <% } %>

            <section class="s-tumblr-stream x-posts image-item-block">

                <% function convert_link(link){
                    var base = config.get('web_link_base');
                    if(!base){ return link; }

                    var base_starts = link.indexOf(base);
                    if(base_starts == -1){ return link; }

                    var ending = link.substr(base_starts+base.length),
                        details = /^\/([a-z_]+)?\/?([A-Z0-9]+)?\/$/.exec(ending);
                    if(details == null){ return link; }

                    var username = details[1],
                        photo_id = details[2];

                    link = '#/feed/?'
                        + (username ? 'username='+username : '')
                        + (username && photo_id ? '&' : '')
                        + (photo_id ? 'photo_id='+photo_id : '')
                        + (!username && photo_id ? '&n=1' : '');
                    return link;

                } %>

                <% _.each(obj.posts || [], function(post){ %>
                    <article class="s-tumblr-post-item">

                        <% switch(post.get('type')) { case 'text': %>

                            <div id="post-<%= post.get('id') %>" class="s-post-<%= post.get('type') %> s-tumblr-post">
                                <div class="s-tumblr-body">
                                <h4 class="s-tumblr-post-title"><%=post.get('title')%></h4>
                                <p class="s-tumblr-post-body"><%=post.get('body').replace(/\n/g, '<br>' )%></p>
                                </div>
                            </div>

                        <% break; case 'photo': %>

                            <div id="post-<%= post.get('id') %>" class="s-post-<%= post.get('type') %> s-tumblr-post">
                                <% if (post.get('photos')) { %>
                                    <div>
                                    <ul class="s-photo-set <% if(post.get('photos').length > 1){ %>s-multiple-photos x-multiple-photos<% } %>">
                                        <% _.each(post.get('photos'), function (photo) { %>
                                            <% var height = 250, size = _.find(photo.alt_sizes, function(size){return size.height >= height}) || size.alt_sizes[photo.alt_sizes.length-1] %>
                                            <li>

                                                <a <%if (post.get('link_url')) {%> href="<%= convert_link(post.get('link_url')) %>"<% } %> >
                                                    <img data-aspect="<%= size.width/size.height %>" class="x-photo <% if(size.height < height){ %>undersize<% } %>" src="<%= size.url %>" />
                                                </a>

                                            </li>
                                        <% }); %>
                                    </ul>
                                </div>
                                <% } %>
                                <div class="s-tumblr-body">
                                <p class="s-tumblr-image-caption"><%=post.get('caption').replace(/\n/g, '<br>' )%></p>
                                </div>
                            </div>

                        <% break; case 'link': %>

                            <div id="post-<%= post.get('id') %>" class="s-post-<%= post.get('type') %> s-tumblr-post">
                                <div class="s-tumblr-body">

                                <h4>
                                    <% if(post.get('title') != ""){%>
                                    <a href="<%= convert_link(post.get('url'))%>"><%=post.get('title')%> <span class="s-tumblr-extra">&rarr;</span></a>
                                    <% } else {%>
                                    <a href="<%= convert_link(post.get('url'))%>"><%=post.get('url')%> <span class="s-tumblr-extra">&rarr;</span></a>
                                    <% } %>
                                    </h4>
                                <p><%=post.get('description').replace(/\n/g, '<br>' )%></p>
                                </div>
                            </div>

                        <% break; case 'video': %>

                            <div id="post-<%= post.get('id') %>" class="s-post-<%= post.get('type') %> s-tumblr-post">
                                <%= getVideoEmbed(post) %>
                                <div class="s-tumblr-body">
                                <% if(post.get('caption')){%><%=post.get('caption').replace(/\n/g, '<br>' )%><%}%>
                                </div>
                            </div>

                        <% break; case 'chat': %>

                           <div id="post-<%= post.get('id') %>" class="s-post-<%= post.get('type') %> s-tumblr-post">
                               <div class="s-tumblr-body">
                                <h4 class="s-tumblr-chat-title"><%=post.get('title')%></h4>
                                <%if (post.get('dialogue')) {%>
                                    <ul class="chat">
                                        <%_.each(post.get('dialogue'), function(dialogue){%>
                                            <li><strong class="s-tumblr-chat-label"><%=dialogue.label%></strong> <%=dialogue.phrase%></li>
                                        <%});%>
                                    </ul>
                                <%}%>
                                </div>
                            </div>

                        <% break; case 'quote': %>

                            <div id="post-<%= post.get('id') %>" class="s-post-<%= post.get('type') %> s-tumblr-post">
                                <div class="s-tumblr-body">
                                <blockquote class="s-tumblr-quote"><%=post.get('text')%></blockquote>
                                <%if (post.get('source')) {%>
                                <p class="s-tumblr-source"><span class="s-tumblr-extra"> &mdash; </span><%=post.get('source')%></p>
                                <%}%>
                                </div>
                            </div>

                        <% break; case 'audio': %>

                            <div id="post-<%= post.get('id') %>" class="s-post-<%= post.get('type') %> s-tumblr-post">

                                <div class="s-tumblr-body">
                                    <audio controls preload="none" src="<%= post.get('audio_url') %>"></audio>
                                    <p>
                                    <%if(post.get('track_name') || post.get('artist') || post.get('album')) { %>
                                        <% if(post.get('artist')) { %><strong><%= post.get('track_name') %></strong><% } %>
                                        <% if(post.get('artist')) { %> by <em class="s-tumblr-artist-name"><%= post.get('artist') %></em><% } %>
                                        <% if(post.get('album')) { %> from <em class="s-tumblr-album-name"><%= post.get('album') %></em> <% } %>
                                    <% } %>
                                    </p>

                                <% if(post.get('caption')){%>
                                    <blockquote class="s-tumblr-track-note"><%=post.get('caption').replace(/\n/g, '<br>' )%></blockquote><%}%>
                                <% if(post.get('source')){%><%=post.get('source') %><%}%>
                                </div>
                            </div>

                        <% }%>
                        <div class="s-tumblr-metadata">
                            <a href="<%= convert_link(post.get('post_url')) %>" class="ui-bar" data-role="button" data-iconpos="right" data-icon="arrow-r" data-theme="z" data-corners="false" data-shadow="false">
                            <span class="ui-icon ui-icon-tumblr-<%= post.get('type') %> tumblr-icon"></span>
                            <%= string_utils.time_ago(post.get('timestamp')*1000) %><% if (post.get('note_count') > 0){ %>, <%= post.get('note_count') %> notes<%}%>
                            </a>
                        </div>
                    </article>

                <% })%>
            </section>
        </div>

        <div class="x-tumblr-footer s-tumblr-footer">
            <% if(obj.host){ %>
                <a href="http://<%= host %>/" data-role="button" data-iconpos="right" data-icon="arrow-r" data-theme="z" data-corners="false" data-shadow="false">
                    <span class="s-tumblr-credit"><%= T('View on') %> <span class="hide">Tumblr</span></span>
                </a>
            <% } %>
        </div>

    </div>
</div>
